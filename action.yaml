name: 'Deploy applications to Argo CD'
description: 'Send applications to Argo CD when to occur project deploy.'
author: 'Robson Andrade<robson.andrade@contraktor.com.br>'
inputs:
  environment:
    description: 'the application environment ( dev, stg, prod )'
    require: 
  application-name:
    description: 'application name'
    require: true
  image-name:
    description: 'same name of repository'
    require: true 
  repository-name:
    description: 'repository that will be cloned'
    require: true 
  path-name:
    description: 'path of environment and platform'
    require: true
  app-influx-name:
    description: 'name app to send deploy metric to influxdb ( combined name of platform name plus application name )'
    require: true
  project-name:
    description: 'combined name of application name plus platform name '
    require: true
  package-name:
    description: 'package name of ghcr to delete'
    require: true

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{secrets.AWS_KEY}}
        aws-secret-access-key: ${{secrets.AWS_SECRET}}
        aws-region: us-east-1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
    
    - name: get app version
      id: app
      env:
        IMAGE: ${{ inputs.image-name }}
        GHCR: 'ghcr.io'
        OWNER: ${{ secrets.ORG_NAME }}
        ENVIRONMENT: ${{ inputs.environment }}
      run: |
        version=`git rev-parse --short HEAD`
        echo "::set-output name=version::${ENVIRONMENT}-$version"
        echo "::set-output name=image::$IMAGE"
        echo "::set-output name=ghcr::$GHCR/$OWNER"
    
    - name: tag docker image to ecr
      env:
        ECR: ${{ steps.login-ecr.outputs.registry }}
        VERSION: ${{ steps.app.outputs.version }}
        IMAGE: ${{ steps.app.outputs.image }}
      run: |
        docker tag $ECR/$IMAGE:$VERSION
    
    - name: tag docker image to ghcr
      env:
        ECR: ${{ steps.login-ecr.outputs.registry }}
        VERSION: ${{ steps.app.outputs.version }}
        IMAGE: ${{ steps.app.outputs.image }}
        GHCR: ${{ steps.app.outputs.ghcr }}
      run: |
        docker tag $ECR/$IMAGE:$VERSION $GHCR/$IMAGE:latest
    
    - name: docker push to ecr
      env:
        ECR: ${{ steps.login-ecr.outputs.registry }}
        VERSION: ${{ steps.app.outputs.version }}
        IMAGE: ${{ steps.app.outputs.image }}
      run: |
        docker push $ECR/$IMAGE:$VERSION
    
    - name: docker login to ghcr
      env:
        USERNAME: ${{ secrets.USERNAME }}
        TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        echo $TOKEN | docker login ghcr.io -u $USERNAME --password-stdin
    
    - name: docker push to ghcr
      env:
        ECR: ${{ steps.login-ecr.outputs.registry }}
        IMAGE: ${{ steps.app.outputs.image }}
        GHCR: ${{ steps.app.outputs.ghcr }}
      run: |
        docker push $GHCR/$IMAGE:latest

    - name: set docker image to rollout
      shell: bash
      env:
        ECR: ${{ steps.login-ecr.outputs.registry }}
        VERSION: ${{ steps.app.outputs.version }}
        IMAGE: ${{ steps.app.outputs.image }}
        APPLICATION_NAME: ${{ inputs.application-name }}
      run: |
        export DOCKER_IMAGE=$ECR/$IMAGE:$VERSION
        envsubst < deploy/rollout-template.yaml > deploy/${APPLICATION_NAME }-rollout.yaml

    - name: clone repository 
      shell: bash
      working-directory: ${{ inputs.repository-name }}
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        OWNER: ${{ secrets.ORG_NAME }}
        REPOSITORY_NAME: ${ inputs.repository-name }
        APPLICATION_NAME: ${ inputs.application-name }}
        PATH_NAME: ${{ inputs.path-name }}
      run: |
        git clone -b master https://oauth2:${GH_TOKEN}@github.com/${OWNER}/${REPOSITORY_NAME}.git ${REPOSITORY_NAME}
        cp deploy/${APPLICATION_NAME}-rollout.yaml ${REPOSITORY_NAME}/${PATH_NAME}/${APPLICATION_NAME}-rollout.yaml
    
    - name: config user admin of github
      shell: bash
      working-directory: ${{ inputs.repository-name }}
      env:
        USERNAME: ${{ secrets.USERNAME }}
        EMAIL: ${{ secrets.EMAIL }}
      run: |
        git config user.name ${USERNAME}
        git config user.email ${EMAIL}
      
    - name: commit alterations at the github
      shell: bash
      working-directory: ${{ inputs.repository-name }}
      run: |
        commit-message=`git show -s --format=%B`  
        git commit -am"$commit-message"
      
    - name: push commit to github
      shell: bash
      working-directory: ${{ inputs.repository-name }}
      run: |     
        git push

    - name: send rollback metric to influxdb
      uses: contraktor-tech/datapoint-producer-action@v2
      env:
        ENVIRONMENT: ${{ inputs.environment }}
      if: |
        ${ENVIRONMENT} == 'prod' &&
        (contains(github.event.head_commit.message, 'rollback') ||
        contains(github.event.head_commit.message, 'revert'))
      with:
        influxdb-token: ${{ secrets.INFLUXDB_TOKEN }}
        influxdb-url: ${{ secrets.INFLUXDB_URL }}
        influxdb-measurement: 'rollback'
        app: 'starter-web-ui'

    - name: send deploy metric to influxdb
      uses: contraktor-tech/datapoint-producer-action@v2
      env:
        ENVIRONMENT: ${{ inputs.environment }}
      if: |
        ${ENVIRONMENT} == 'prod' &&
        (!contains(github.event.head_commit.message, 'rollback') &&
        !contains(github.event.head_commit.message, 'revert'))
      with:
        influxdb-token: ${{ secrets.INFLUXDB_TOKEN }}
        influxdb-url: ${{ secrets.INFLUXDB_URL }}
        influxdb-measurement: 'deploy'
        app: ${{ inputs.app-influx-name}}
    
    - name: deploy has succeeded - Send notification deploy to Slack
      uses: contraktor-tech/slack-notification-action@feat/CK-1953
      if: ${{ success() }}
      with:
        slack-hook: ${{ secrets.SLACK_HOOK }}
        project-name: ${{ inputs.project-name }}
        environment-name: ${{ inputs.environment }}
        deploy-status: 'success'

    - name: deploy has failed - Send notification deploy to Slack
      uses: contraktor-tech/slack-notification-action@feat/CK-1953
      if: ${{ failure() }}
      with:
        slack-hook: ${{ secrets.SLACK_HOOK }}
        project-name: ${{ inputs.project-name }}
        environment-name: ${{ inputs.environment }}
        deploy-status: 'failure'

    - name: delete ghcr packages
      uses: i9cloud-tech/delete-untagged-ghcr-action@master
      with:
        org: ${{ secrets.ORG_NAME }}
        gh-token: ${{ secrets.GH_TOKEN }}
        package-name: ${{ inputs.package-name }}